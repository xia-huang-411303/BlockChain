在分布式系统中， #共识 是指各个参与节点通过共识协议达成一致的过程。如何通过共识算法实现共识的过程就被称为 #共识机制 。
[[共识问题]]的研究源远流长，共识问题的理论发展为共识算法的发展打下了坚实的基础。

#共识算法 是区块链技术的基础和核心，决定了集群节点之间以何种方式对交易的执行顺序与内容达成一致，保障节点账本数据的一致性。
对区块链系统而言，不同共识算法基于不同的基本假设，使用不同的实现方式，提供不同的故障容错及节点参与方式等特性，其分类维度是多样的。其中常见的维度归纳如下：

## 共识算法的分类
### 容错类型
#### 崩溃容错共识（Crash Fault Tolerance Consensus）
能够在节点消息存在延迟或丢失等崩溃错误的网络中，确保分布式系统的正常节点间就特定数据达成一致的共识算法，称为崩溃容错共识算法。
#### 拜占庭容错共识（Byzantine Fault Tolerance Consensus）
能够在节点消息存在延迟、丢失、重复甚至内容伪造等拜占庭错误的网络中，确保分布式系统正常节点间就特定数据达成一致的共识算法，称为拜占庭容错共识算法。
### 节点身份认证
#### 授权共识（Permissioned Consensus）
授权共识是指节点在通过身份认证后才能参与的共识机制。授权共识中，节点的加入与退出都是受管理的，因此共识节点数量相对稳定，每个节点都能获知参与节点数量和身份等信息。
#### 非授权共识（Permissionless Consensus）
非授权共识是指节点不需要经过身份认证，即可自由加入或退出共识流程的共识机制。非授权共识中，网络中节点数量可能随时变化，节点也无法获知系统所有参与节点数量和身份等信息。
### 实现方式
#### 基于纯软件实现共识
以纯软件的方式实现的共识算法，灵活性高、通用性强，但所有特性的实现都依赖CPU算力和网络带宽，性能容易遇到瓶颈。
#### 基于软硬结合实现共识
以软件与硬件结合的方式实现的共识算法，例如，以硬件安全能力提升抗攻击性的共识算法。由于硬件的高性能与高可靠性，通常具有更优异的性能表现与更强的稳定性，但需要依赖特定的硬件环境，可移植性较弱。

## 共识算法设计与选型

共识算法类型丰富，并不存在适应所有场景需求的完美算法，因此需要设计者针对应用场景的关键需求进行合理设计与选型。为此，我们将基于以上分类维度，结合实际场景需求，将较为常用的共识算法归结为以下几类，相信能为读者进行共识算法设计与选型提供一定帮助：
![[面向场景需求的共识简要分类.png|500]]

### 证明类共识算法
2008年，以比特币为代表的区块链系统正式进入大众视野。区块链网络的开放性、安全性、可扩展性、去中心化、大规模化，对共识机制提出了新的挑战，这也为区块链共识算法的崛起打下了坚实基础。
#证明类共识算法 （Proof of X， #PoX ）是区块链共识机制的主流。
在这类算法中，共识节点通常被称为 #矿工 。在每一轮共识过程中，矿工节点中必须通过提供某种证明与其他矿工节点竞争，胜出的节点将获得记账权，生成区块并获取相应的收益。典型的算法包括工作量证明（ProofofWork，[[PoW]]）、权益证明（ProofofStake，[[PoS]]）、委托权益证明算法（[[DPoS]]），等等。

### 拜占庭容错共识算法
拜占庭容错（Byzantine Fault Tolerance，[[BFT]]）共识起源于1982年LeslieLamport提出的[[拜占庭将军问题]]。其论文借多位拜占庭将军围攻敌军的虚构场景，来解释异步系统中存在恶意节点情况下的共识问题。
拜占庭假设是对现实世界的模型化，由于硬件错误、网络拥塞或断开以及遭到恶意攻击，计算机和网络可能出现不可预料的行为。拜占庭容错协议必须处理这些失效，并且这些协议还要满足所要解决的问题要求的规范。
拜占庭容错共识算法的核心在于少数服从多数。这些算法通常以 $f$ 表示算法可以容忍的错误节点数上限。很多经典算法问题只有在集群总节点数N满足$N≥3f+1$才有解。

在随后的1999年，迎来了拜占庭共识研究的里程碑，Castro和Liskov提出的实用拜占庭容错算法（Practical Byzantine Fault Tolerance，[[PBFT]]），将算法复杂度降低到多项式级。作为第一个有工程实践意义的拜占庭容错共识算法，PBFT能在诚实节点超过2/3的半同步网络中，以多项式级的消息复杂度在诚实节点间达成共识。
但随着区块链场景的出现，人们发现只有将复杂度进一步降低，才能适应新场景中大规模网络的需求。
2019年Gueta、Abraham等提出的可扩展拜占庭容错算法（Scalable Byzantine Fault Tolerance，[[SBFT]]），以及同于2019年aofanYin、Malkhi等提出的[[HotStuff]]算法等，已经将算法降低到线性复杂度，并在区块链领域落地应用。

### 崩溃容错共识算法
崩溃容错（CrushFaultTolerance，[[CFT]]）共识算法假设网络中共识节点均为“诚实”节点或可信节点，即节点均按照既定算法协议履行职责，不会出现拜占庭将军问题。
该类算法可在系统出现如网络、磁盘故障或服务器宕机等故障的情况下仍正常运行，可容忍不超过一半的故障节点。
崩溃容错共识算法以分布式数据库为主要应用场景，实现节点间状态机复制的功能。早期的算法主要以分布式数据库为应用场景，节点并不会对外开放，工程中以崩溃容错为主要诉求。
这些算法通常被称为经典分布式共识算法，常被应用于联盟链或私有链中，以提供更高效的共识服务，提升系统性能。
崩溃容错共识算法的发展可以追溯到1998年，[[Paxos]]算法随着Lamport尘封9年之久的论文的发布最终面世，标志着崩溃容错共识领域的里程碑。
Paxos算法论文中Lamport以讲故事的方式，描述了在一个虚构的希腊城邦Paxos上的议员们如何在可能存在消息丢失与延迟的情况下，就某项提案达成共识的机制。
Paxos中的提案-批准制，节点分工配合等基本思想对后来的分布式共识算法有着深远影响，其本身也在Google的Chubby、Spanner等一系列产品有所应用。
自1998年Paxos正式发表以来，研究人员在此基础上增加了BasicPaxos、E-Paxos等多个改进版本，逐步形成了Paxos算法家族。
但是早期的Paxos算法仍然晦涩难懂，其算法结构难以直接应用到实际的系统中。
2013年，为了解决Paxos难以理解与实现的问题，斯坦福大学DiegoOngaro、JohnOusterhout提出[[Raft]]共识算法，并在知名分布式项目中获得广泛应用，如服务发现框架consul、配置信息管理框架etcd，等等。
崩溃容错共识算法虽然性能较高，能够容忍网络中一定数量的节点崩溃，却不能应对拜占庭攻击，只在不会存在拜占庭节点的区块链网络中才能选用，这是需要注意的。

### 基于TEE的共识算法
随着纯软共识算法性能瓶颈问题愈发凸显，研究者们开始探索结合硬件技术提升性能的解决方案。
2009年，一种高性能、高可靠的硬件安全技术——可信执行环境（Trusted Execution Environment， [[TEE]]）进入人们的视野。TEE能为数据存储和代码执行提供安全的运行空间，约束攻击者作恶行为。TEE与共识算法结合，可以有效提高系统的抗攻击性。
例如，可以使用TEE生成节点公钥与私钥，私钥保存在TEE中，即使节点被攻击者劫持，TEE仍然可以避免私钥被攻击者盗用并伪造消息，避免集群受到恶意消息的攻击，大大提升了系统对拜占庭攻击的抵抗性，同时具备优异的性能。
典型算法如备受瞩目的 [[FastBFT]] 算法，就是结合TEE技术实现了低时延、高吞吐的拜占庭容错。

