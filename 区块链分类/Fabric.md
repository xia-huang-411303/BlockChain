## 核心思想

#Fabric 是一个带有节点许可管理的[[联盟链]]系统。

### 认证与共识
在传统的区块链系统中，系统对节点的加入没有限制，这使得系统的治理非常复杂。
为了利用区块链的特性，同时避免复杂的系统治理，Fabric采用了带有 #许可认证 的节点管理方式，也就是系统是在一系列已知的、具有特定身份标识的成员之间进行交互。
虽然对于系统来说，节点本身身份是已知的，但是节点之间并不互相信任，所以节点之间还是需要一个一致性的算法来保证数据是可信的。区别于 比特币 等公有链系统的 PoW 算法，在节点可知的Fabric系统中，可以采用传统的 #BFT 类共识算法。

### 执行模式
传统的区块链系统采用的是一种顺序执行的方式，交易是在排序完成之后或者是排序的过程中执行 智能合约 生成的。这使得所有节点都必须按顺序执行智能合约（order-excute-update），限制系统的可扩展性和性能。

Fabric使用了一种具有创新意义的的架构，称之为“ #执行-排序-验证-提交”模型。使得Fabric有更好的扩展性和灵活性；而且交易 #预先执行 的方式避免了非确定性的状态，也使得系统能够抵抗一些恶意攻击，如资源耗尽。

在这样的模型基础上，Fabric能够将 #交易 拆分为 #构建区块 和 #更新状态 两个阶段，一方面，使得系统可以将交易的执行、排序、提交单独剥离出来，让系统的架构更加灵活；另一方面，也使得系统架构更加具有扩展性，开发者可以针对不一样的企业需求，对执行、排序、验证、提交各个阶段定制不一样的服务。


## 整体架构

在前面的设计思想的基础上，Fabric充分利用了模块化的设计、容器技术和密码学技术，使得系统具有可扩展性、灵活性和安全性。

### 架构设计核心思想
总体来说，在具体架构设计上，Fabric主要采用了以下几个核心思想：
1) 高效的可扩展性。
2) 共识算法模块化 。
3) 灵活的链码信任机制。
4) 更强的隐私保护。

在Fabric系统中， #链码 （ #Chaincode ）即智能合约。链码的运行与 #交易背书 、 #区块打包 在功能上可以分割到不同节点角色上完成，交易背书的 （ #背书节点 #Endorser ）与区块打包的 #排序节点 （ #Orderer ）解耦。相比于其他区块链系统中所有节点对等的设计方式，这将保证系统有更好的伸缩性。

Fabric系统中的区块打包可以由一组 #排序节点 共同承担，从而实现对部分节点失败或者错误行为的容忍。
Fabric系统将 #共识 交由 #排序节点 来完成，并且允许各类共识算法以插件的形式应用于排序节点，从而使用户能够根据具体的应用场景和错误模型选择不同类型和特性的共识算法，比如  #Solo 共识、 #Kafka 共识、 #PBFT 共识等。

对于每一个 #链码 ， #背书节点 都可以是不同的节点。而当不同链码指定了相互独立的背书节点时，不同链码的执行将相互独立开来，保证了交易执行的隐私性、可靠性。

为了保护用户、交易的隐私及安全，Fabric实现了一套完整的 #数据加密 传输、处理机制。
另外，通过将不同的业务或用户通过 #通道 （ #Channel ） #隔离 ，实现数据的隔离，从而进一步保护隐私。
同时，其特有的智能合约执行流程也对用户隐私进行了一定程度的保护。

### 系统逻辑架构
从系统逻辑架构的角度来看，Fabric系统主要提供 成员管理、区块链服务、智能合约服务、监听服务、客户端等。Fabric的系统逻辑架构见图。
![[Fabric系统逻辑架构.png|450]]
其各个服务介绍如下：
#### 成员管理服务
#成员管理服务 为网络节点提供了管理身份、隐私、机密和审计的功能。
Fabric采用了 #PKI公钥体系 ，每一个网络节点首先需要先向 #证书颁发机构 （ #CA ）获取 #身份证书 ，然后使用身份证书加入Fabric网络。节点发起操作的时候，需要带上节点的签名，系统会检查 #交易签名 是否合法，并且具有指定的交易或者管理权限。
#### 区块链服务
#区块链服务 主要包含 #交易管理 和 #账本管理 。
Fabric中客户端提交交易请求， #背书节点 进行背书，通过 #共识管理 模块将交易排序打包生成区块文件，主记账节点获取到区块之后，通过 #P2P协议 广播区块到不同的 #记账节点 中，记账节点拿到区块之后，通过 #账本存储管理 模块写入本地账本中。上层应用程序还可以通过 #账本管理 模块查询交易，包括通过交易号、区块编号、区块哈希值，等等。
#### 智能合约服务
Fabric采用 #Docker 作为其链码的安全执行环境。一方面，可以确保链码执行和用户本地数据隔离，保证安全；另一方面，可以更容易地为支持多种语言的链代码提供智能合约开发的灵活性。
#### 监听服务
用于监听交易的最终执行状态。交易在打包进区块之后，还需要校验交易的签名是否符合背书策略、是否存在“双花”等问题。交易通过校验即执行成功，可以通过监听服务获取。

### 系统部署架构
![[Fabric系统部署架构.png|350]]
从系统部署架构的角度来看，Fabric系统常见的网络部署架构如上图所示。
在常见的部署方式中，Fabric区块链系统一般是由多个组织构成的，每一个组织有自己的背书节点、排序节点、记账节点和主节点。系统中主要包含 客户端、 Peer、Orderer 和  CA。

#### Orderer
排序节点功能比较单一，主要完成交易排序的功能。 #Orderer 为网络中所有合法交易进行全局排序，并将一批排序后的交易组成区块结构，传送至 #记账节点 进行区块落盘的动作。
#### Peer
Peer节点是整个Fabric系统中的核心节点， #Peer 节点根据功能不同可以划分为背书节点、记账节点、主节点，而且一个Peer节点可能有多个功能。因为Peer节点的功能独立，这也使得节点的加入和退出比较灵活。
其具体作用分别如下：
#主节点 ：该节点会定期从 #Orderer 获取排序后的批量交易 #区块 结构，对这些交易进行落盘前的检查，并最终对交易进行落盘（写入账本）。一般主节点也是记账节点。
#记账节点 ：负责维护区块链账本结构。
#背书节点 ：背书节点由 #客户端 指定。被某个客户端指定的背书节点需要完成对相应交易提案的背书处理。具体的交易背书过程为：收到来自 #客户端 的 #交易提案 后，首先进行合法性和权限检查，若检查通过，则背书节点在其本地对交易所调用的链码进行模拟运行，并对交易导致的状态变化进行背书，并返回结果给客户端。
#### CA
#证书颁发机构 负责网络中所有 证书 的管理，实现标准的PKI架构。
#### 客户端
#客户端 是调用Fabric服务的节点。要发出一个对Fabric系统的访问，首先客户端需要获取合法的 #身份证书 来加入Fabric网络内的应用 #通道 。客户端在发起交易时，先要构造 #交易提案 （ #Proposal ），提交给 #背书节点 背书。在收集到足够的背书后，可以组装背书结果构造一个合法的 #交易请求 ，再发给 #Orderer 进行排序处理，Orderer排序确认后最终被组装成 #区块 并发送至 #记账节点 完成交易的落盘。


## Fabric交易流程

区别于比特币的UTXO模型，Fabric项目使用的模型是 #账户余额模型 。
账户余额模型类似于日常所使用的银行卡，银行系统记录了银行卡对应账户所剩余的余额，当我们需要使用银行卡去交易的时候，银行会在批准交易前检查以确保我们有足够的余额。

账户余额模型更加简单和高效，基于Fabric的智能合约开发者可以直观地根据账户是否有足够的余额来判断交易是否可以进行，因此也可以开发出更加复杂的智能合约。

在Fabric中账户信息存储在称之为 #世界状态 （ #WorldState ）的对象中。
#世界状态 代表了当前账本所有账户的最新值，在实际实现中，世界状态是通过Key-Value对象存储的，用户可以直接根据账户获取账户信息的最新值，而不需要遍历整个区块文件进行计算。

每笔交易会对世界状态中一个或多个账户进行读取、更新或者删除操作，Fabric将这种交易操作抽象成 #读写集对象 。
#读集 包含 #链码 中对 #世界状态 里账户的 所有读操作 以及 对应读取到的版本， #版本 用 对应账户最后一次被合法更新的 交易 所在区块的编号和交易编号 来表示； #写集 包含待更新的所有账户和对应的账户信息。
Fabric利用交易的读写集来保证对世界状态更新的全局一致性。

![[Fabric的交易流程.png|600]]
整个交易的过程如图所示。
1) #客户端 SDK发送 #交易提案 给 #背书节点 ，提案中包含调用者的签名和应用程序生成的 #交易号 。 #背书节点 和 #记账节点 可以通过交易号检查是否有重复的交易。
2) #背书节点 调用对应的 #链码 执行交易操作，生成 #读写集 。 #链码 程序会查询 #世界状态 中对应的账户，生成读集，然后执行一系列业务逻辑，最后计算出对世界状态中账户和账户信息的更新，生成写集。 #背书节点 对这个过程进行记录，最后的结果生成了一个 #读写集对象 。
3) #背书节点 将背书结果返回给 #客户端 SDK，其中包含 #读写集对象 。
4) #客户端 SDK将包含读写集的背书结果打包成交易发送给 #排序节点 。
5) #排序节点 会接收到来自不同 #客户端 的并行交易，它在内部将交易 #排序 编号，然后组装成 #区块 。
6) #记账节点 从 #排序节点 拉取 #区块 。
7) #记账节点 验证区块合法性。例如，验证交易是否满足背书规则，交易是否存在“双花”等。如果交易验证通过，则将 #区块 写入本地的 #区块链账本 ，同时将区块中合法交易包含的 #写集 内容写入世界状态数据库中。
这样一次完整的交易就完成了。


## Fabric共识设计

#共识服务 在Fabric系统中占有十分重要的地位。所有交易在发送到Fabric系统以后，都要经由共识服务对 #交易顺序 进行共识，然后将交易按序打包进入区块链，保证了任意一笔交易在区块链中的位置在整个Fabric系统中各节点上的一致性和唯一确定性。当前Fabric最新版本中，官方提供的共识服务主要有Solo、Kafka和Raft三种共识算法。这几种算法简要介绍如下：
1) #Solo ：提供单节点的排序功能。只有一个节点，不能进行扩展，也不支持容错，仅供测试，不建议在生产环境下使用。
2) #Kafka ：提供基于Kafka集群的排序功能。支持 #CFT （CrashFaultTolerance），支持持久化，可以进行扩展，是允许CFT情况下，Fabric当前推荐在生产环境下使用的共识方法。
3) #Raft ：Fabric在1.4版本中新增了Raft共识算法。Raft是一种主从模型，常用于分布式数据库中。通过选举产生主节点，然后直接从主节点复制数据。Raft节点具有一定的容错能力，只要超过一半的节点正常运作，则整个网络即可以正常运转。当主节点异常后，会重新选举产生主节点。
在0.6的Alpha版本中，Fabric还支持过 #PBFT 实用拜占庭容错共识算法，这是一种状态副本复制算法，不同共识节点保存了一个状态机副本，副本里面保存了服务的操作和状态。在系统可能存在f个失效节点的情况下，如果能保证系统总的节点个数大于3f+1，那么在PBFT算法下系统总能达成一致状态。在后续正式版本1.X中不再包含该共识算法。

## Fabric智能合约

智能合约是区块链的重要组成部分之一，在Fabric系统中，智能合约被称为 #链码 。
#链码 分为两类，分别是 #系统链码 和 #用户链码 。
#系统链码 主要是实现系统管理的功能，同时提供系统内置的功能，因为在系统中内置，减少了链码和背书节点通信的开销。
#用户链码 是用户编写的智能合约。

Fabric支持使用Golang、Nodejs、Java语言来编写链码，这些语言对大多数应用开发者来说并不陌生，能够快速上手，有利于区块链应用的快速开发。

链码运行在容器中，使得智能合约的执行和背书节点进程及账本分离。
在Fabric系统中，用户链码的整个生命周期中主要有开发、安装、实例化、升级、运行几个阶段。各阶段简要介绍如下：
#### 开发
用户基于Fabric所提供的 #链码接口 （ #ChaincodeStub ）操作状态数据块以完成智能合约代码。最终形成的是Golang或者其他语言的代码文件。
#### 安装
管理员指定链代码的名称和版本号，调用SDK将链码文件打包发送给 #背书节点 。背书节点将链码包以链码名称和版本号的组合形式（例如，mychaincode.1.0），存储在本地特定的目录下。
在很多公有云服务供应商提供区块链即服务（BaaS）的情况下，链码的安装和后续实例化及升级都可以一键完成，增强了区块链的易用性。
#### 实例化
管理员指定通道、链码名称、版本号、背书策略和链码初始化函数，向 #背书节点 发起实例化请求，背书节点从本地链码包获取链代码文件。根据不同的链码语言，背书节点使用对应语言的编译器编译链码文件，生成可执行文件，并将可执行文件打包生成一个Docker镜像，然后使用该镜像创建一个运行对应链码的容器。链码启动后和 #Peer 之间通过 #gRPC 进行通信。
#### 升级
链码升级过程主要是使用新的链码文件上传到 #背书节点 ，然后生成新的链码镜像和容器的过程。链码名称必须保持一致，链码版本号必须是不一样的，但是没有大小规则，也就是最后升级的链码就是最新的。
#### 运行
在运行阶段，链码主要完成用户的交易操作。用户通过gRPC向背书节点发起对应链码的调用请求，背书节点将请求转发给链码。链码执行智能合约逻辑，在此过程中，它会有多次和 #世界状态 数据进行交互的过程，包括从 #背书节点 状态数据库中读取特定的值和向背书节点状态数据库中写入特定的值。

## Fabric安全及隐私保护

区块链的安全和隐私主要体现在以下几个方面的需求：交易数据安全保密、不可更改，交易匿名，符合监管和审计的要求。为了满足这些需求，Fabric采用了密码学相关的技术，包括 对称加解密、非对称加解密、 #数字摘要 等。

![[Fabric安全服务模块.png|500]]
如上图所示，为了实现更加灵活的安全隐私服务，Fabric将安全服务模块划分为通道管理、通信管理、身份管理、区块链密码服务管理模块。

#### BCCSP服务
区块链密码服务管理提供了一组密码学的工具，基于这个工具集来实现应用层的数据安全和隐私保护。它提供了包括非对称加密（RSA）、分组加密算法（AES）、椭圆曲线签名（ECDSA）、哈希算法（HASH）、哈希消息认证码（HMAC）、X.509证书、标准的安全接口（PKCS11）。如果要支持国密算法，则需要扩展BCCSP服务。
#### 通道管理服务
#通道 （ #Channel ）是Fabric的一种保护机制，用于交易参与方安全地和Peer进行通信而对其他参与方不可见，另外对于一个通道而言，具备自己独立的服务空间，也就是说，背书、链码、链码执行环境都是独立的，部署和升级链码也只是影响当前的通道。
管理员通过 #通道配置文件 （configtx.yaml）创建 #创世块 ，创世块里面保存了一些配置和安全标识；创世块会被 #客户端 从 #背书节点 获取回来，作为加入通道的依据。
#### 身份管理服务
#身份管理服务 （MembershipServiceProvider， #MSP ）习惯直译为成员关系服务提供者。在一个运行Fabric系统的网络中有众多的参与者，MSP就是为了管理这些参与者，辨识验证哪些人有资格，哪些人没有资格，既维护某一个参与者的权限，也维护参与者之间的关系。MSP中也使用了BCCSP提供的密码学服务，因为MSP维护了参与者的权限，一旦泄露，对系统可能产生不可估量的损失。
#### 通信服务
不同节点之间是通过 #gRPC 通信的，主要是通过 #TLS 来保证信道的安全。
