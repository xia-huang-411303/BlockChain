# 以太坊系统

[[以太坊/历史]]

本部分将对以太坊的一些设计思路，包括其账户模型、采用的挖矿算法、提供的智能合约实现等，进行简要的介绍。

## 以太坊账户模型
与比特币不同，以太坊没有采用UTXO模型，而是采用了传统记账系统的账户模型，即每个用户对应一个直接记录余额的账户，交易中附带有参与交易的账户的信息。相比于比特币的UTXO模型，以太坊所采用的传统账户模型显然更易于理解和进行智能合约的编程。

具体地，以太坊的每一个账户都由一对公私钥进行定义，账户的地址为其公钥的最后20个字节，以太坊以地址来对账户进行索引。在以太坊中，共有两种账户模型，即 #外部拥有账户 （Externally owned account，EOAs）和 #合约账户 （Contract account）。
以太坊的外部拥有账户一般是给用户分配的账户，拥有该账户的用户可以通过账户对应的私钥创建和签署交易，发送消息至其他外部账户或合约账户。合约账户一般是由合约代码控制的账户，可以被外部拥有账户触发从而执行其对应的合约代码，进行各种预先定义好的操作。
这些账户都是具有状态的“实体账户”（相对于比特币的“虚拟账户”），例如，外部账户有余额，合约账户有余额和合约储存。以太坊中所有账户的状态即以太坊网络的状态，以太坊通过产生区块对其状态进行更新。

以太坊的账户状态包括如下四个部分：
1) nonce：随机数，用于唯一指定一个交易或合约代码；
2) balance：账户余额；
3) root：账户状态树的树根的哈希值；
4) codeHash：账户合约代码的哈希值，对外部拥有账户，此字段为空。

## 以太坊共识算法

在比特币所使用的SHA-256挖矿算法中，挖矿的速度与机器的算力成正比，从而催生了利用大规模专用矿机集群进行合作挖矿的集中式矿场，降低了比特币的去中心化程度，

因此，以太坊1.0中采用了与比特币类似的[[PoW]]共识机制，但其所选用的挖矿算法与比特币不同，采取了[[Ethash]]算法作为其工作量证明算法。Ethash算法具有挖矿效率与内存大小和内存带宽正相关的特点，这就防止了部分矿场通过堆叠专用矿机算力而获取挖矿效率上的提升。

以太坊2.0采用权益证明（ProofofStake，[[PoS]]）共识算法替代PoW。

以太坊挖矿的难度调整是动态进行的，每个区块的难度系数都会根据上一区块的生成时间、上一区块的难度系数以及区块高度等因素由指定计算公式计算得出，并写在相应的区块头中。由于以太坊尚处于不断的开发迭代演进中，其具体使用的难度计算公式及其中的参数都处于不断的变化调整中

## 以太坊智能合约

以太坊为区块链系统添加了[[以太坊/智能合约]]的实现。

相比于比特币所提供的极为受限的交易脚本语言，以太坊所提供的智能合约极大增强了区块链的功能，同时也为区块链赋予了可编程性。通过以太坊平台提供的智能合约编程语言和相应的对智能合约进行解释执行的以太坊虚拟机，区块链开发者可以直接在以太坊平台上进行各种可能的操作的开发，赋予以太坊区块链各种方向的应用。


## 以太坊虚拟机EVM

我们可以将以太坊视为一个可以实现去中心化应用的平台，其核心是一套用于对运行以太坊的节点所要执行的智能合约进行编程的语言，以及相应的在保证节点运行其他服务的环境不受影响的条件下，对所编写的智能合约语言代码进行解释执行的虚拟机([[以太坊虚拟机]] ，EVM)。

用户通过调用以太坊提供的接口对自己所希望部署的去中心化应用进行编写，在调用时，通过共识协议在所有以太坊节点间对将要执行的智能合约达成一致，进而在每个节点的EVM上进行执行。

## 典型的以太坊应用

随着以太坊的不断发展，基于以太坊的开发者生态圈已经相对完善。目前，已有数千个基于以太坊开发的[[DApp]]正在运营中。[State of the DApps](http：//www.stateofthedapps.com/)网站集合了当前各类DApp（其底层平台包括但不限于以太坊）当前的用户量、交易量以及用户月活量等信息。
目前DApp所涉及的领域囊括游戏、金融、社交、博彩、交易市场、软件开发、媒体、钱包、治理、安全、财产、存储、身份、能源、健康、保险等16个领域。

由于涉及的领域已经很广泛，所以相较于本书上个版本时的统计并没有太大变化，但是每个领域的DApp数量及DApp的质量都有较大提升。
实际上，当前各类DApp的用户量及用户活跃度都十分有限，究其原因，以太坊本身的性能无疑是限制DApp发展的一个因素。有评论认为，当前在以太坊上开发DApp，相当于在20世纪60年代的硬件上进行计算。

以太坊同时也在提供一些基础设施服务，典型代表是[[以太坊域名服务]]（Ethereum Name Service，ENS）。

## 以太坊与ICO
尽管V神启动以太坊项目的初衷是为DApp开发者们提供开发去中心化分布式应用的平台，但以太坊的大规模推广以及以太币的大幅度增值都与ICO的大范围开展和ERC-20（Ethereum Request for Comment-20）标准的发布息息相关。
ICO是以众筹的方式换取投资者手中的资金（通常为比特币或以太坊）。而ERC-20标准，则是以太坊的代币设计标准，它提供了一系列对基于以太坊智能合约构建的数字代币的规则和标准，利用以太坊智能合约，任何人都能够按照ERC-20标准中所要求的几个规则进行填充，编写对应的智能合约代码，从而发行自己的ERC-20代币，大大降低了发行代币的门槛。显然，比起DApp，以太坊在数字代币发行方面的应用也很受关注。随着区块链技术影响的扩大，在2017年及2018年年初，曾掀起了一股ICO热潮。由于发币的成本大幅度降低，利用以太坊，甚至在10分钟内就可以发行一种所谓的“数字货币”。这些“空气币”一方面极大地提升了以太坊项目本身的影响力；另一方面又使得ICO项目整体的公信度急剧下降，给普通群众一种“割韭菜”的不良印象。在国内，随着监管政策的及时发布，这类项目也迅速消失在大众的视线中。

## 以太坊2.0升级
在以太坊这样的系统中，系统软件的升级并不能像普通的单机系统或者中心化的云服务升级一样，去中心化的特质意味着系统的更新需要耗费较多的时间及工程量。

当前以太坊上同时存在PoW和PoS两条链，未来这两条链会逐步融合。以太坊2.0的升级将分为4个阶段进行（[来源](https://www.coindesk.com/tech/2020/12/01/ethereum-20-beacon-chain-goes-live-as-world-computer-begins-long-awaited-overhaul/)）。
![[以太坊2.0的升级.png]]
第一个阶段被称作“阶段0”，目标是实施信标链，作为其他分片的信任根。信标链部署完成后，将会引入PoS共识算法，存储和管理验证者的交易。
第二个阶段被称作“阶段1”，计划于2021年启动，目标是引入分片。PoS共识算法的验证者会被分配到不同的片上出块，将每个分片通过交叉链锚定到信标链，验证者会将相关信息提交到信标链上。
第三个阶段被称作“阶段1.5”，以太坊的共识算法正式升级为PoS，并将当前的网络作为2.0的一个分片。
第四个阶段被称作“阶段2”，基于eWASM的执行虚拟机，添加分片链的执行引擎，以便在分片链上安装智能合约，并执行交易。每个分片都可以访问所有的运行环境，并进行跨片交易。

## 以太坊2.0分片机制
在以太坊2.0升级的第一个阶段，分片被添加到系统中。最初的计划是以1024个分片开始，但现在这个数字已经减少到64个。信标链仍然被认为是主链，但现在也包含分片引用。由于有64个分片，而每个信标区块可以与64个分片相关联，所以假设在正常操作中，每个信标区块可以与每个分片相关联。分片区块和信标区块之间采用双向链接机制，分片链区块引用信标区块（带有信标区块的哈希值），以及信标区块引用分片链区块，分片链平行于主链，信标链作为网络的系统链，将确保整个网络的共识和状态的最终性，并将促成分片链之间的跨分片通信。
![[以太坊2.0分片系统中的区块结构示意图.png]]
